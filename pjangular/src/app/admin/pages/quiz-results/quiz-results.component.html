<nz-card nzTitle="üìä Qu·∫£n l√Ω K·∫øt qu·∫£ B√†i ki·ªÉm tra" class="quiz-results-card">

  <form nz-form [formGroup]="searchForm" (ngSubmit)="searchQuizResults()" *ngIf="isAdmin" class="search-form">
    <div nz-row nzGutter="16">
      <div nz-col nzXs="24" nzSm="12" nzMd="8" nzLg="6">
        <nz-form-item class="filter-item">
          <nz-form-label class="form-label">
            <i nz-icon nzType="user"></i> Ng∆∞·ªùi d√πng
          </nz-form-label>
          <nz-form-control>
            <nz-select
              formControlName="userId"
              nzPlaceHolder="Ch·ªçn ng∆∞·ªùi d√πng"
              nzAllowClear
              nzShowSearch
              class="custom-select"
            >
              <nz-option *ngFor="let user of users" [nzValue]="user.userId" [nzLabel]="user.username"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>

      <div nz-col nzXs="24" nzSm="12" nzMd="8" nzLg="6">
        <nz-form-item class="filter-item">
          <nz-form-label class="form-label">
            <i nz-icon nzType="file-text"></i> B√†i ki·ªÉm tra
          </nz-form-label>
          <nz-form-control>
            <nz-select
              formControlName="quizId"
              nzPlaceHolder="Ch·ªçn b√†i ki·ªÉm tra"
              nzAllowClear
              nzShowSearch
              class="custom-select"
            >
              <nz-option *ngFor="let quiz of quizzes" [nzValue]="quiz.quizId" [nzLabel]="quiz.title"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>

      <div nz-col nzXs="24" nzSm="12" nzMd="8" nzLg="6">
        <nz-form-item class="filter-item">
          <nz-form-label class="form-label">
            <i nz-icon nzType="trophy"></i> ƒêi·ªÉm t·ª´
          </nz-form-label>
          <nz-form-control>
            <nz-input-number
              formControlName="minScore"
              [nzMin]="0"
              [nzMax]="100"
              nzPlaceHolder="ƒêi·ªÉm t·ªëi thi·ªÉu"
              class="custom-input-number"
            ></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>

      <div nz-col nzXs="24" nzSm="12" nzMd="8" nzLg="6">
        <nz-form-item class="filter-item">
          <nz-form-label class="form-label">
            <i nz-icon nzType="trophy"></i> ƒêi·ªÉm ƒë·∫øn
          </nz-form-label>
          <nz-form-control>
            <nz-input-number
              formControlName="maxScore"
              [nzMin]="0"
              [nzMax]="100"
              nzPlaceHolder="ƒêi·ªÉm t·ªëi ƒëa"
              class="custom-input-number"
            ></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>

      <div nz-col nzXs="24" nzSm="24" nzMd="24" nzLg="24" class="button-col-full">
        <div class="filter-buttons">
          <button nz-button nzType="primary" htmlType="submit" [nzLoading]="loading" class="search-button">
            <i nz-icon nzType="search"></i> T√¨m ki·∫øm
          </button>
          <button nz-button (click)="resetFilters()" class="reset-button">
            <i nz-icon nzType="reload"></i> ƒê·∫∑t l·∫°i
          </button>
        </div>
      </div>
    </div>
  </form>

  <nz-divider *ngIf="isAdmin"></nz-divider>

  <div class="table-actions" *ngIf="isAdmin">
    <button nz-button nzType="primary" (click)="showResultModal(false)" class="add-button">
      <i nz-icon nzType="plus-circle"></i> Th√™m K·∫øt Qu·∫£ M·ªõi
    </button>
  </div>

  <nz-table
    #basicTable
    [nzData]="pageData.content" [nzLoading]="loading"
    [nzNoResult]="'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ b√†i ki·ªÉm tra n√†o.'"
    [nzFrontPagination]="false" [nzTotal]="pageData.totalElements" [nzPageSize]="pageData.pageSize" [nzPageIndex]="pageData.currentPage + 1" (nzPageIndexChange)="onPageIndexChange($event)" (nzPageSizeChange)="onPageSizeChange($event)" nzBordered
    *ngIf="isAdmin"
    class="quiz-results-table"
  >
    <thead>
      <tr>
        <th
          nzColumnKey="resultId"
          [nzSortFn]="true" (nzSortOrderChange)="onSortChange('resultId', $event === 'ascend' ? 'ascend' : ($event === 'descend' ? 'descend' : null))" class="table-header"
        >
          ID
        </th>
        <th
          nzColumnKey="userId"
          [nzSortFn]="true"
          (nzSortOrderChange)="onSortChange('userId', $event === 'ascend' ? 'ascend' : ($event === 'descend' ? 'descend' : null))"
          class="table-header"
        >
          <i nz-icon nzType="user"></i> Ng∆∞·ªùi d√πng
        </th>
        <th
          nzColumnKey="quizId"
          [nzSortFn]="true"
          (nzSortOrderChange)="onSortChange('quizId', $event === 'ascend' ? 'ascend' : ($event === 'descend' ? 'descend' : null))"
          class="table-header"
        >
          <i nz-icon nzType="file-text"></i> B√†i ki·ªÉm tra
        </th>
        <th
          nzColumnKey="score"
          [nzSortFn]="true"
          (nzSortOrderChange)="onSortChange('score', $event === 'ascend' ? 'ascend' : ($event === 'descend' ? 'descend' : null))"
          class="table-header"
        >
          <i nz-icon nzType="score"></i> ƒêi·ªÉm s·ªë
        </th>
        <th
          nzColumnKey="completedAt"
          [nzSortFn]="true"
          (nzSortOrderChange)="onSortChange('completedAt', $event === 'ascend' ? 'ascend' : ($event === 'descend' ? 'descend' : null))"
          class="table-header"
        >
          <i nz-icon nzType="clock-circle"></i> Ho√†n th√†nh l√∫c
        </th>
        <th
          nzColumnKey="durationSeconds"
          [nzSortFn]="true"
          (nzSortOrderChange)="onSortChange('durationSeconds', $event === 'ascend' ? 'ascend' : ($event === 'descend' ? 'descend' : null))"
          class="table-header"
        >
          <i nz-icon nzType="hourglass"></i> Th·ªùi l∆∞·ª£ng (gi√¢y)
        </th>
        <th class="table-header">H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let result of basicTable.data" class="table-row">
        <td>{{ result.resultId }}</td>
        <td>{{ getUserUsername(result.userId) }}</td>
        <td>{{ getQuizTitle(result.quizId) }}</td>
        <td>{{ result.score }}</td>
        <td>{{ result.completedAt | date: 'medium' }}</td>
        <td>{{ result.durationSeconds || 'N/A' }}</td>
        <td class="actions-cell">
          <a (click)="showResultModal(true, result)" nz-tooltip nzTooltipTitle="S·ª≠a k·∫øt qu·∫£ n√†y"><i nz-icon nzType="edit"></i> S·ª≠a</a>
          <nz-divider nzType="vertical"></nz-divider>
          <a nz-popconfirm nzPopconfirmTitle="B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?" (nzOnConfirm)="deleteResult(result.resultId)" nzOkText="X√≥a" nzCancelText="H·ªßy" nzOkDanger nz-tooltip nzTooltipTitle="X√≥a k·∫øt qu·∫£ n√†y">
            <i nz-icon nzType="delete"></i> X√≥a
          </a>
        </td>
      </tr>
    </tbody>
  </nz-table>

  <div *ngIf="!isAdmin" class="no-permission-message">
    <p><i nz-icon nzType="stop"></i> B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n l√Ω k·∫øt qu·∫£ b√†i ki·ªÉm tra.</p>
  </div>

  <nz-modal
    [(nzVisible)]="isVisible"
    [nzTitle]="isEdit ? '‚úèÔ∏è S·ª≠a k·∫øt qu·∫£ b√†i ki·ªÉm tra' : '‚ûï Th√™m k·∫øt qu·∫£ b√†i ki·ªÉm tra'"
    (nzOnOk)="handleResultModalOk()"
    (nzOnCancel)="handleResultModalCancel()"
    [nzOkText]="isEdit ? 'C·∫≠p nh·∫≠t' : 'T·∫°o m·ªõi'"
    [nzCancelText]="'H·ªßy'"
    [nzOkType]="'primary'"
    [nzContent]="modalContent"
    class="modal"
  >
    <ng-template #modalContent>
      <form nz-form [formGroup]="resultForm" class="modal-form">
        <nz-form-item class="modal-item">
          <nz-form-label nzRequired><i nz-icon nzType="user"></i> Ng∆∞·ªùi d√πng</nz-form-label>
          <nz-form-control [nzErrorTip]="(resultForm.get('userId')?.invalid && resultForm.get('userId')?.touched) ? 'Ng∆∞·ªùi d√πng l√† b·∫Øt bu·ªôc' : undefined">
            <nz-select formControlName="userId" nzPlaceHolder="Ch·ªçn ng∆∞·ªùi d√πng" nzShowSearch [nzDisabled]="isEdit">
              <nz-option *ngFor="let user of users" [nzValue]="user.userId" [nzLabel]="user.username"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="modal-item">
          <nz-form-label nzRequired><i nz-icon nzType="file-text"></i> B√†i ki·ªÉm tra</nz-form-label>
          <nz-form-control [nzErrorTip]="(resultForm.get('quizId')?.invalid && resultForm.get('quizId')?.touched) ? 'B√†i ki·ªÉm tra l√† b·∫Øt bu·ªôc' : undefined">
            <nz-select formControlName="quizId" nzPlaceHolder="Ch·ªçn b√†i ki·ªÉm tra" nzShowSearch [nzDisabled]="isEdit">
              <nz-option *ngFor="let quiz of quizzes" [nzValue]="quiz.quizId" [nzLabel]="quiz.title"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="modal-item">
          <nz-form-label nzRequired><i nz-icon nzType="score"></i> ƒêi·ªÉm s·ªë</nz-form-label>
          <nz-form-control [nzErrorTip]="(resultForm.get('score')?.invalid && resultForm.get('score')?.touched) ? 'ƒêi·ªÉm s·ªë l√† b·∫Øt bu·ªôc v√† ph·∫£i t·ª´ 0-100' : undefined">
            <nz-input-number formControlName="score" [nzMin]="0" [nzMax]="100" nzPlaceHolder="Nh·∫≠p ƒëi·ªÉm s·ªë"></nz-input-number>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="modal-item">
          <nz-form-label><i nz-icon nzType="hourglass"></i> Th·ªùi l∆∞·ª£ng (gi√¢y)</nz-form-label>
          <nz-form-control [nzErrorTip]="(resultForm.get('durationSeconds')?.invalid && resultForm.get('durationSeconds')?.touched) ? 'Th·ªùi l∆∞·ª£ng ph·∫£i l√† s·ªë d∆∞∆°ng' : undefined">
            <nz-input-number formControlName="durationSeconds" [nzMin]="0" nzPlaceHolder="Nh·∫≠p th·ªùi l∆∞·ª£ng"></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </form>
    </ng-template>
  </nz-modal>
</nz-card>

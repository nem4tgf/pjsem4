<nz-card nzTitle="üì¶ Qu·∫£n l√Ω ƒê∆°n h√†ng" class="orders-card">
  <form *ngIf="isAdmin" nz-form [formGroup]="searchForm" (ngSubmit)="searchOrders()" class="search-form">
    <div nz-row [nzGutter]="16">
      <div nz-col nzXs="24" nzSm="12" nzMd="8" nzLg="6">
        <nz-form-item>
          <nz-form-label><i nz-icon nzType="user"></i> T√™n ng∆∞·ªùi d√πng</nz-form-label>
          <nz-form-control>
            <input nz-input formControlName="username" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi d√πng" />
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col nzXs="24" nzSm="12" nzMd="8" nzLg="6">
        <nz-form-item>
          <nz-form-label><i nz-icon nzType="profile"></i> Tr·∫°ng th√°i</nz-form-label>
          <nz-form-control>
            <nz-select formControlName="status" nzPlaceHolder="Ch·ªçn tr·∫°ng th√°i" nzAllowClear>
              <nz-option *ngFor="let status of statusOptions" [nzValue]="status" [nzLabel]="status"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col nzXs="24" nzSm="12" nzMd="8" nzLg="6">
        <nz-form-item>
          <nz-form-label><i nz-icon nzType="calendar"></i> Ng√†y t·ª´</nz-form-label>
          <nz-form-control>
            <nz-date-picker formControlName="minDate" nzPlaceHolder="Ch·ªçn ng√†y b·∫Øt ƒë·∫ßu" class="custom-input"></nz-date-picker>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col nzXs="24" nzSm="12" nzMd="8" nzLg="6">
        <nz-form-item>
          <nz-form-label><i nz-icon nzType="calendar"></i> Ng√†y ƒë·∫øn</nz-form-label>
          <nz-form-control>
            <nz-date-picker formControlName="maxDate" nzPlaceHolder="Ch·ªçn ng√†y k·∫øt th√∫c" class="custom-input"></nz-date-picker>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col nzXs="24" class="button-col-full">
        <div class="filter-buttons">
          <button nz-button nzType="primary" [nzLoading]="loading" htmlType="submit">
            <i nz-icon nzType="search"></i> T√¨m ki·∫øm
          </button>
          <button nz-button (click)="resetFilters()">
            <i nz-icon nzType="reload"></i> ƒê·∫∑t l·∫°i
          </button>
        </div>
      </div>
    </div>
  </form>

  <nz-divider *ngIf="isAdmin"></nz-divider>

  <nz-table
    #orderTable
    [nzData]="orders"
    [nzLoading]="loading"
    [nzNoResult]="'Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o ph√π h·ª£p.'"
    [nzFrontPagination]="false"
    [nzTotal]="pageData.totalElements"
    [nzPageSize]="pageData.size"
    [nzPageIndex]="pageData.number + 1"
    (nzQueryParams)="onQueryParamsChange($event)"
    nzBordered
    class="orders-table"
  >
    <thead>
      <tr>
        <th [nzSortFn]="true" nzColumnKey="orderId">ID</th>
        <th>Ng∆∞·ªùi ƒë·∫∑t h√†ng</th>
        <th [nzSortFn]="true" nzColumnKey="orderDate">Ng√†y ƒë·∫∑t</th>
        <th [nzSortFn]="true" nzColumnKey="totalAmount">T·ªïng ti·ªÅn</th>
        <th [nzSortFn]="true" nzColumnKey="status">Tr·∫°ng th√°i</th>
        <th>ƒê·ªãa ch·ªâ</th>
        <th *ngIf="isAdmin">H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let order of orderTable.data">
        <td>{{ order.orderId }}</td>
        <td>
          <i nz-icon nzType="user" class="user-icon"></i>
          {{ order.user?.fullName || 'N/A' }} ({{ order.user?.email || 'N/A' }})
        </td>
        <td>{{ order.orderDate | date: 'dd/MM/yyyy HH:mm' }}</td>
        <td>{{ order.totalAmount | currency:'VND':'symbol-narrow' }}</td>
        <td>
          <nz-tag [nzColor]="getStatusTagColor(order.status)">{{ order.status }}</nz-tag>
        </td>
        <td>{{ order.shippingAddress || 'N/A' }}</td>
        <td *ngIf="isAdmin" class="actions-cell">
          <a (click)="showOrderDetailModal(order)"><i nz-icon nzType="eye"></i> Xem</a>
          <nz-divider nzType="vertical"></nz-divider>
          <a (click)="showUpdateStatusModal(order)"><i nz-icon nzType="edit"></i> S·ª≠a</a>
          <nz-divider nzType="vertical"></nz-divider>
          <a (click)="deleteOrder(order.orderId)"><i nz-icon nzType="delete"></i> X√≥a</a>
        </td>
      </tr>
    </tbody>
  </nz-table>
</nz-card>

<ng-template #orderDetailModalContent>
  <div *ngIf="selectedOrder">
    <p><i nz-icon nzType="user"></i> <b>Ng∆∞·ªùi ƒë·∫∑t:</b> {{ selectedOrder.user?.fullName || 'N/A' }} ({{ selectedOrder.user?.email || 'N/A' }})</p>
    <p><i nz-icon nzType="calendar"></i> <b>Ng√†y ƒë·∫∑t:</b> {{ selectedOrder.orderDate | date: 'dd/MM/yyyy HH:mm:ss' }}</p>
    <p><i nz-icon nzType="dollar"></i> <b>T·ªïng ti·ªÅn:</b> {{ selectedOrder.totalAmount | currency:'VND':'symbol-narrow' }}</p>
    <p><i nz-icon nzType="info-circle"></i> <b>Tr·∫°ng th√°i:</b> <nz-tag [nzColor]="getStatusTagColor(selectedOrder.status)">{{ selectedOrder.status }}</nz-tag></p>
    <p><i nz-icon nzType="home"></i> <b>ƒê·ªãa ch·ªâ:</b> {{ selectedOrder.shippingAddress || 'Ch∆∞a cung c·∫•p' }}</p>

    <nz-divider nzText="üìö S·∫£n ph·∫©m trong ƒë∆°n h√†ng"></nz-divider>

    <nz-table [nzData]="selectedOrder.items || []" nzSize="small" [nzShowPagination]="false" nzBordered>
      <thead>
        <tr>
          <th>ID</th>
          <th>ID B√†i h·ªçc</th>
          <th>Ti√™u ƒë·ªÅ</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>Gi√° t·∫°i th·ªùi ƒëi·ªÉm</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of selectedOrder.items">
          <td>{{ item.orderDetailId }}</td>
          <td>{{ item.lesson?.lessonId || 'N/A' }}</td>
          <td>{{ item.lesson?.title || 'N/A' }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.priceAtPurchase | currency:'VND':'symbol-narrow' }}</td>
        </tr>
      </tbody>
    </nz-table>
  </div>
</ng-template>

<ng-template #updateStatusModalContent>
  <form *ngIf="orderToUpdateStatus" [formGroup]="updateStatusForm">
    <p>M√£ ƒë∆°n h√†ng: <b>#{{ orderToUpdateStatus.orderId }}</b></p>
    <p>Tr·∫°ng th√°i hi·ªán t·∫°i: <nz-tag [nzColor]="getStatusTagColor(orderToUpdateStatus.status)">{{ orderToUpdateStatus.status }}</nz-tag></p>
    <nz-form-item>
      <nz-form-label>Ch·ªçn tr·∫°ng th√°i m·ªõi</nz-form-label>
      <nz-form-control nzErrorTip="Vui l√≤ng ch·ªçn tr·∫°ng th√°i m·ªõi">
        <nz-select formControlName="newStatus" nzPlaceHolder="Ch·ªçn tr·∫°ng th√°i...">
          <nz-option *ngFor="let status of statusOptions" [nzValue]="status" [nzLabel]="status"></nz-option>
        </nz-select>
      </nz-form-control>
    </nz-form-item>
  </form>
</ng-template>

<nz-card nzTitle="üìà Qu·∫£n l√Ω Ti·∫øn ƒë·ªô" class="progress-card">

  <div *ngIf="isAdmin" class="add-button-container">
    <button nz-button nzType="primary" (click)="showAddProgressModal()">
      <i nz-icon nzType="plus-circle"></i> Th√™m Ti·∫øn ƒë·ªô M·ªõi
    </button>
  </div>

  <nz-divider *ngIf="isAdmin"></nz-divider>

  <form nz-form [formGroup]="searchForm" (ngSubmit)="searchProgress()" *ngIf="isAdmin" class="search-form">
    <div nz-row nzGutter="16">
      <div nz-col nzSpan="6">
        <nz-form-item>
          <nz-form-label class="form-label"><i nz-icon nzType="user"></i> User ID</nz-form-label>
          <nz-form-control>
            <nz-input-number formControlName="userId" [nzMin]="1" [nzStep]="1" [nzPrecision]="0" placeholder="T√¨m theo User ID" class="custom-input"></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col nzSpan="6">
        <nz-form-item>
          <nz-form-label class="form-label"><i nz-icon nzType="book"></i> Lesson ID</nz-form-label>
          <nz-form-control>
            <nz-input-number formControlName="lessonId" [nzMin]="1" [nzStep]="1" [nzPrecision]="0" placeholder="T√¨m theo Lesson ID" class="custom-input"></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col nzSpan="6">
        <nz-form-item>
          <nz-form-label class="form-label"><i nz-icon nzType="bulb"></i> Lo·∫°i ho·∫°t ƒë·ªông</nz-form-label>
          <nz-form-control>
            <nz-select formControlName="activityType" nzPlaceHolder="Ch·ªçn lo·∫°i ho·∫°t ƒë·ªông" nzAllowClear class="custom-select">
              <nz-option *ngFor="let activityType of activityTypes" [nzValue]="activityType" [nzLabel]="activityType"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col nzSpan="6">
        <nz-form-item>
          <nz-form-label class="form-label"><i nz-icon nzType="info-circle"></i> Tr·∫°ng th√°i</nz-form-label>
          <nz-form-control>
            <nz-select formControlName="status" nzPlaceHolder="Ch·ªçn tr·∫°ng th√°i" nzAllowClear class="custom-select">
              <nz-option *ngFor="let status of statuses" [nzValue]="status" [nzLabel]="status"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col nzSpan="6">
        <nz-form-item>
          <nz-form-label class="form-label"><i nz-icon nzType="percentage"></i> Ho√†n th√†nh t·ª´ (%)</nz-form-label>
          <nz-form-control>
            <nz-input-number formControlName="minCompletionPercentage" [nzMin]="0" [nzMax]="100" nzPlaceHolder="Min %" class="custom-input"></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col nzSpan="6">
        <nz-form-item>
          <nz-form-label class="form-label"><i nz-icon nzType="percentage"></i> Ho√†n th√†nh ƒë·∫øn (%)</nz-form-label>
          <nz-form-control>
            <nz-input-number formControlName="maxCompletionPercentage" [nzMin]="0" [nzMax]="100" nzPlaceHolder="Max %" class="custom-input"></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div class="form-actions">
      <button nz-button nzType="primary" [nzLoading]="loading" htmlType="submit" class="search-button">
        <i nz-icon nzType="search"></i> T√¨m ki·∫øm
      </button>
      <button nz-button (click)="resetFilters()" class="reset-button">
        <i nz-icon nzType="reload"></i> ƒê·∫∑t l·∫°i
      </button>
    </div>
  </form>

  <nz-divider *ngIf="isAdmin"></nz-divider>

  <nz-table
    #basicTable
    [nzData]="progressList"
    [nzLoading]="loading"
    [nzNoResult]="'Kh√¥ng t√¨m th·∫•y b·∫£n ghi ti·∫øn ƒë·ªô n√†o.'"
    [nzFrontPagination]="false"
    [nzTotal]="pageData.totalElements"
    [nzPageSize]="pageData.size"
    [nzPageIndex]="pageData.page + 1" (nzPageIndexChange)="onPageIndexChange($event)"
    (nzPageSizeChange)="onPageSizeChange($event)"
    nzBordered
    *ngIf="isAdmin"
    class="progress-table"
  >
    <thead>
      <tr>
        <th class="table-header" [nzSortFn]="true" (nzSortOrderChange)="onSortChange('userId', $event === 'ascend' ? 'ASC' : 'DESC')">Ng∆∞·ªùi d√πng</th>
        <th class="table-header" [nzSortFn]="true" (nzSortOrderChange)="onSortChange('lessonId', $event === 'ascend' ? 'ASC' : 'DESC')">B√†i h·ªçc</th>
        <th class="table-header" [nzSortFn]="true" (nzSortOrderChange)="onSortChange('activityType', $event === 'ascend' ? 'ASC' : 'DESC')">Ho·∫°t ƒë·ªông</th>
        <th class="table-header" [nzSortFn]="true" (nzSortOrderChange)="onSortChange('status', $event === 'ascend' ? 'ASC' : 'DESC')">Tr·∫°ng th√°i</th>
        <th class="table-header" [nzSortFn]="true" (nzSortOrderChange)="onSortChange('completionPercentage', $event === 'ascend' ? 'ASC' : 'DESC')">Ho√†n th√†nh (%)</th>
        <th class="table-header" [nzSortFn]="true" (nzSortOrderChange)="onSortChange('lastUpdated', $event === 'ascend' ? 'ASC' : 'DESC')">C·∫≠p nh·∫≠t l√∫c</th>
        <th *ngIf="isAdmin" class="table-header">H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let progress of basicTable.data">
        <td>{{ getUserUsername(progress.userId) }}</td>
        <td>{{ getLessonTitle(progress.lessonId) }}</td>
        <td>{{ progress.activityType }}</td>
        <td>
          <nz-tag [nzColor]="getProgressStatusTagColor(progress.status)">
            {{ progress.status }}
          </nz-tag>
        </td>
        <td>{{ progress.completionPercentage }}%</td>
        <td>{{ progress.lastUpdated | date: 'medium' }}</td>
        <td *ngIf="isAdmin" class="actions-cell">
          <a (click)="showEditProgressModal(progress)" class="edit-link">
            <i nz-icon nzType="edit" class="icon-edit"></i> S·ª≠a
          </a>
          <nz-divider nzType="vertical"></nz-divider>
          <a (click)="deleteProgress(progress.progressId!)" class="delete-link">
            <i nz-icon nzType="delete" class="icon-delete"></i> X√≥a
          </a>
        </td>
      </tr>
    </tbody>
  </nz-table>

  <div *ngIf="!isAdmin" class="no-permission-message">
    <p><i nz-icon nzType="close-circle"></i> B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n l√Ω ti·∫øn ƒë·ªô.</p>
  </div>

  <nz-modal
    [(nzVisible)]="isProgressModalVisible"
    [nzTitle]="isEditMode ? 'C·∫≠p nh·∫≠t Ti·∫øn ƒë·ªô' : 'Th√™m Ti·∫øn ƒë·ªô M·ªõi'"
    nzOkText="L∆∞u"
    nzCancelText="H·ªßy"
    (nzOnOk)="handleProgressModalOk()"
    (nzOnCancel)="handleProgressModalCancel()"
    [nzOkLoading]="loading"
    [nzWidth]="800"
  >
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="progressForm" class="progress-modal-form">
        <div nz-row nzGutter="16">
          <div nz-col nzSpan="12">
            <nz-form-item>
              <nz-form-label nzRequired><i nz-icon nzType="user"></i> Ng∆∞·ªùi d√πng</nz-form-label>
              <nz-form-control [nzErrorTip]="progressForm.get('userId')?.hasError('required') ? 'Ng∆∞·ªùi d√πng l√† b·∫Øt bu·ªôc' : ''">
                <nz-select
                  formControlName="userId"
                  nzPlaceHolder="Ch·ªçn ng∆∞·ªùi d√πng"
                  [nzDisabled]="isEditMode"
                  nzShowSearch
                  [nzFilterOption]="filterUserOption"
                  (nzOpenChange)="loadUsers()"
                >
                  <nz-option *ngFor="let user of users" [nzValue]="user.userId" [nzLabel]="user.username"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzSpan="12">
            <nz-form-item>
              <nz-form-label nzRequired><i nz-icon nzType="book"></i> B√†i h·ªçc</nz-form-label>
              <nz-form-control [nzErrorTip]="progressForm.get('lessonId')?.hasError('required') ? 'B√†i h·ªçc l√† b·∫Øt bu·ªôc' : ''">
                <nz-select
                  formControlName="lessonId"
                  nzPlaceHolder="Ch·ªçn b√†i h·ªçc"
                  [nzDisabled]="isEditMode"
                  nzShowSearch
                  [nzFilterOption]="filterLessonOption"
                  (nzOpenChange)="loadLessons()"
                >
                  <nz-option *ngFor="let lesson of lessons" [nzValue]="lesson.lessonId" [nzLabel]="lesson.title"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzSpan="12">
            <nz-form-item>
              <nz-form-label nzRequired><i nz-icon nzType="bulb"></i> Lo·∫°i ho·∫°t ƒë·ªông</nz-form-label>
              <nz-form-control [nzErrorTip]="progressForm.get('activityType')?.hasError('required') ? 'Lo·∫°i ho·∫°t ƒë·ªông l√† b·∫Øt bu·ªôc' : ''">
                <nz-select formControlName="activityType" nzPlaceHolder="Ch·ªçn lo·∫°i ho·∫°t ƒë·ªông">
                  <nz-option *ngFor="let activityType of activityTypes" [nzValue]="activityType" [nzLabel]="activityType"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzSpan="12">
            <nz-form-item>
              <nz-form-label nzRequired><i nz-icon nzType="info-circle"></i> Tr·∫°ng th√°i</nz-form-label>
              <nz-form-control [nzErrorTip]="progressForm.get('status')?.hasError('required') ? 'Tr·∫°ng th√°i l√† b·∫Øt bu·ªôc' : ''">
                <nz-select formControlName="status" nzPlaceHolder="Ch·ªçn tr·∫°ng th√°i">
                  <nz-option *ngFor="let status of statuses" [nzValue]="status" [nzLabel]="status"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzSpan="12">
            <nz-form-item>
              <nz-form-label nzRequired><i nz-icon nzType="percentage"></i> Ho√†n th√†nh (%)</nz-form-label>
              <nz-form-control [nzErrorTip]="
                progressForm.get('completionPercentage')?.hasError('required') ? 'Ph·∫ßn trƒÉm ho√†n th√†nh l√† b·∫Øt bu·ªôc' :
                (progressForm.get('completionPercentage')?.hasError('min') || progressForm.get('completionPercentage')?.hasError('max'))
                ? 'Ph·∫£i t·ª´ 0 ƒë·∫øn 100' : ''
              ">
                <nz-input-number formControlName="completionPercentage" [nzMin]="0" [nzMax]="100" nzPlaceHolder="Nh·∫≠p %"></nz-input-number>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>
      </form>
    </ng-container>
  </nz-modal>
</nz-card>

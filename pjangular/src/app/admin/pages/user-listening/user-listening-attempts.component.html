<nz-card nzTitle="üéß Qu·∫£n l√Ω L·∫ßn th·ª≠ Nghe" class="attempt-card">

  <!-- =============================================================== -->
  <!-- N·ªòI DUNG CH√çNH (HI·ªÇN TH·ªä KHI L√Ä ADMIN) -->
  <!-- =============================================================== -->
  <div *ngIf="isAdmin; else noPermission">
    <!-- Form L·ªçc D·ªØ Li·ªáu -->
    <form nz-form [formGroup]="filterForm" (ngSubmit)="applyFilters()" class="filter-form">
      <div nz-row [nzGutter]="16">
        <!-- Filter Ng∆∞·ªùi d√πng -->
        <div nz-col nzXs="24" nzSm="12" nzMd="8" nzLg="6">
          <nz-form-item>
            <nz-form-label><i nz-icon nzType="user"></i> Ng∆∞·ªùi d√πng</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="userId" nzPlaceHolder="Ch·ªçn ng∆∞·ªùi d√πng" nzAllowClear nzShowSearch>
                <nz-option *ngFor="let user of users" [nzValue]="user.userId" [nzLabel]="user.username"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Filter Ho·∫°t ƒë·ªông -->
        <div nz-col nzXs="24" nzSm="12" nzMd="8" nzLg="6">
          <nz-form-item>
            <nz-form-label><i nz-icon nzType="question-circle"></i> Ho·∫°t ƒë·ªông</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="practiceActivityId" nzPlaceHolder="Ch·ªçn ho·∫°t ƒë·ªông" nzAllowClear nzShowSearch>
                <nz-option *ngFor="let activity of practiceActivities" [nzValue]="activity.activityId" [nzLabel]="activity.title"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Filter ƒêi·ªÉm t·ª´ -->
        <div nz-col nzXs="24" nzSm="12" nzMd="8" nzLg="6">
          <nz-form-item>
            <nz-form-label><i nz-icon nzType="percentage"></i> ƒêi·ªÉm t·ª´</nz-form-label>
            <nz-form-control>
              <nz-input-number class="full-width-input" formControlName="minAccuracyScore" nzPlaceHolder="T·ªëi thi·ªÉu" [nzMin]="0" [nzMax]="100"></nz-input-number>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Filter ƒêi·ªÉm ƒë·∫øn -->
        <div nz-col nzXs="24" nzSm="12" nzMd="8" nzLg="6">
          <nz-form-item>
            <nz-form-label><i nz-icon nzType="percentage"></i> ƒêi·ªÉm ƒë·∫øn</nz-form-label>
            <nz-form-control>
              <nz-input-number class="full-width-input" formControlName="maxAccuracyScore" nzPlaceHolder="T·ªëi ƒëa" [nzMin]="0" [nzMax]="100"></nz-input-number>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- C√°c n√∫t b·∫•m -->
        <div nz-col nzXs="24" class="button-col">
          <div class="filter-buttons">
            <button nz-button nzType="primary" htmlType="submit" [nzLoading]="loading">
              <i nz-icon nzType="search"></i> T√¨m ki·∫øm
            </button>
            <button nz-button (click)="resetFilters()">
              <i nz-icon nzType="reload"></i> ƒê·∫∑t l·∫°i
            </button>
            <button nz-button nzType="dashed" (click)="openCreateModal()">
              <i nz-icon nzType="plus"></i> Th√™m m·ªõi
            </button>
          </div>
        </div>
      </div>
    </form>

    <nz-divider></nz-divider>

    <!-- B·∫£ng D·ªØ Li·ªáu -->
    <nz-table
      #basicTable
      [nzData]="pageData.content"
      [nzTotal]="pageData.totalElements"
      [nzPageIndex]="pageData.page + 1"
      [nzPageSize]="pageData.size"
      [nzLoading]="loading"
      [nzNoResult]="'Kh√¥ng t√¨m th·∫•y l·∫ßn th·ª≠ nghe n√†o.'"
      [nzShowPagination]="true"
      nzBordered
      [nzFrontPagination]="false"
      nzShowSizeChanger
      [nzPageSizeOptions]="[5, 10, 20, 50]"
      [nzShowTotal]="totalTemplate"
      (nzQueryParams)="onQueryParamsChange($event)"
      class="attempts-table"
    >
      <thead>
        <tr>
          <th>ID</th>
          <th><i nz-icon nzType="user"></i> Ng∆∞·ªùi d√πng</th>
          <th><i nz-icon nzType="question-circle"></i> Ho·∫°t ƒë·ªông</th>
          <th><i nz-icon nzType="form"></i> VƒÉn b·∫£n ng∆∞·ªùi d√πng</th>
          <th><i nz-icon nzType="percentage"></i> ƒê·ªô ch√≠nh x√°c</th>
          <th><i nz-icon nzType="calendar"></i> Ng√†y th·ª≠</th>
          <th><i nz-icon nzType="setting"></i> H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let attempt of basicTable.data">
          <td>{{ attempt.attemptId }}</td>
          <td>{{ getUserUsername(attempt.userId) }}</td>
          <td>{{ getPracticeActivityTitle(attempt.practiceActivityId) }}</td>
          <td>{{ attempt.userTranscribedText }}</td>
          <td>
            <nz-tag [nzColor]="attempt.accuracyScore >= 80 ? 'green' : (attempt.accuracyScore >= 50 ? 'blue' : 'red')">
              {{ attempt.accuracyScore }}%
            </nz-tag>
          </td>
          <td>{{ attempt.attemptDate | date: 'dd/MM/yyyy HH:mm' }}</td>
          <td class="actions-cell">
            <a (click)="openEditModal(attempt)" nz-tooltip nzTooltipTitle="Ch·ªânh s·ª≠a">
              <i nz-icon nzType="edit"></i> S·ª≠a
            </a>
            <nz-divider nzType="vertical"></nz-divider>
            <a
              nz-popconfirm
              nzPopconfirmTitle="B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·∫ßn th·ª≠ n√†y?"
              (nzOnConfirm)="deleteAttempt(attempt.attemptId)"
              nzOkText="X√≥a"
              nzCancelText="H·ªßy"
              nzOkDanger
              nz-tooltip
              nzTooltipTitle="X√≥a"
            >
              <i nz-icon nzType="delete"></i> X√≥a
            </a>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </div>

  <!-- =============================================================== -->
  <!-- MODAL CH·ªàNH S·ª¨A -->
  <!-- =============================================================== -->
  <nz-modal
    [(nzVisible)]="isVisibleEditModal"
    nzTitle="Ch·ªânh s·ª≠a L·∫ßn th·ª≠ Nghe"
    (nzOnCancel)="handleEditCancel()"
    (nzOnOk)="handleEditOk()"
    [nzOkLoading]="isEditLoading"
    nzOkText="L∆∞u thay ƒë·ªïi"
    nzCancelText="H·ªßy"
  >
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="editForm">
        <nz-form-item>
          <nz-form-label [nzSm]="8" [nzXs]="24" nzRequired>Ng∆∞·ªùi d√πng</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui l√≤ng ch·ªçn ng∆∞·ªùi d√πng!">
            <nz-select formControlName="userId" nzShowSearch nzAllowClear>
              <nz-option *ngFor="let user of users" [nzValue]="user.userId" [nzLabel]="user.username"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label [nzSm]="8" [nzXs]="24" nzRequired>Ho·∫°t ƒë·ªông</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui l√≤ng ch·ªçn ho·∫°t ƒë·ªông!">
            <nz-select formControlName="practiceActivityId" nzShowSearch nzAllowClear>
              <nz-option *ngFor="let activity of practiceActivities" [nzValue]="activity.activityId" [nzLabel]="activity.title"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label [nzSm]="8" [nzXs]="24" nzRequired>VƒÉn b·∫£n ng∆∞·ªùi d√πng</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui l√≤ng nh·∫≠p vƒÉn b·∫£n!">
            <textarea nz-input formControlName="userTranscribedText" rows="3"></textarea>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label [nzSm]="8" [nzXs]="24" nzRequired>ƒê·ªô ch√≠nh x√°c (%)</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="ƒêi·ªÉm t·ª´ 0-100!">
            <nz-input-number formControlName="accuracyScore" [nzMin]="0" [nzMax]="100" [nzStep]="1"></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </form>
    </ng-container>
  </nz-modal>

  <!-- =============================================================== -->
  <!-- MODAL TH√äM M·ªöI -->
  <!-- =============================================================== -->
  <nz-modal
    [(nzVisible)]="isVisibleCreateModal"
    nzTitle="Th√™m M·ªõi L·∫ßn th·ª≠ Nghe"
    (nzOnCancel)="handleCreateCancel()"
    (nzOnOk)="handleCreateOk()"
    [nzOkLoading]="isCreateLoading"
    nzOkText="T·∫°o m·ªõi"
    nzCancelText="H·ªßy"
  >
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="createForm">
        <nz-form-item>
          <nz-form-label [nzSm]="8" [nzXs]="24" nzRequired>Ng∆∞·ªùi d√πng</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui l√≤ng ch·ªçn ng∆∞·ªùi d√πng!">
            <nz-select formControlName="userId" nzShowSearch nzAllowClear>
              <nz-option *ngFor="let user of users" [nzValue]="user.userId" [nzLabel]="user.username"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label [nzSm]="8" [nzXs]="24" nzRequired>Ho·∫°t ƒë·ªông</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui l√≤ng ch·ªçn ho·∫°t ƒë·ªông!">
            <nz-select formControlName="practiceActivityId" nzShowSearch nzAllowClear>
              <nz-option *ngFor="let activity of practiceActivities" [nzValue]="activity.activityId" [nzLabel]="activity.title"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label [nzSm]="8" [nzXs]="24" nzRequired>VƒÉn b·∫£n ng∆∞·ªùi d√πng</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui l√≤ng nh·∫≠p vƒÉn b·∫£n!">
            <textarea nz-input formControlName="userTranscribedText" rows="3"></textarea>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label [nzSm]="8" [nzXs]="24" nzRequired>ƒê·ªô ch√≠nh x√°c (%)</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="ƒêi·ªÉm t·ª´ 0-100!">
            <nz-input-number formControlName="accuracyScore" [nzMin]="0" [nzMax]="100" [nzStep]="1"></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </form>
    </ng-container>
  </nz-modal>

  <!-- =============================================================== -->
  <!-- TEMPLATES PH·ª§ -->
  <!-- =============================================================== -->
  <ng-template #noPermission>
    <nz-result
      nzStatus="403"
      nzTitle="403"
      nzSubTitle="Xin l·ªói, b·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y."
    ></nz-result>
  </ng-template>

  <ng-template #totalTemplate let-total let-range="range">
    Hi·ªÉn th·ªã {{ range[0] }}-{{ range[1] }} tr√™n t·ªïng s·ªë {{ total }} b·∫£n ghi
  </ng-template>

</nz-card>
